# config/settings.py
"""통합 설정 파일"""

import os
from typing import Dict, Any, List

class AISettings:
    """AI 서비스 통합 설정"""
    
    # LLM 설정
    LLM_CONFIG = {
        "temperature": 0.1,
        "max_tokens": 2000,
        "model_name": "gpt-3.5-turbo"
    }
    
    # 시스템 메시지 (한글 응답 강화)
    SYSTEM_MESSAGE = """
당신은 한국어로 수학을 가르치는 전문 교수입니다. 
모든 응답은 반드시 한국어로 작성해주세요.
수학적 정확성과 함께 학생이 이해하기 쉽도록 명확하고 친근한 한국어로 설명해주세요.
"""
    
    # Agent 설정
    AGENT_CONFIG = {
        "max_iterations": 10,
        "early_stopping_method": "generate",
        "handle_parsing_errors": True,
        "verbose": True
    }
    
    # 메모리 설정
    MEMORY_CONFIG = {
        "memory_key": "chat_history",
        "return_messages": True,
        "k": 3  # 최근 3개 대화만 유지
    }
    
    # 도구 목록
    AVAILABLE_TOOLS = ["wikipedia", "llm-math", "arxiv"]
    
    # 피드백 톤 설정
    FEEDBACK_TONES = {
        "초급": "친근하고 격려적인 톤으로 피드백을 제공하세요. 실수를 지적하기보다는 개선 방향을 제시하는 데 집중하세요.",
        "중급": "전문적이면서도 건설적인 톤으로 피드백을 제공하세요. 정확한 평가와 함께 도전적인 학습 방향을 제시하세요.",
        "고급": "학술적이고 심도 있는 톤으로 피드백을 제공하세요. 고급 개념과의 연결점을 제시하고 추가 탐구를 권장하세요."
    }
    
    # 힌트 제공 원칙
    HINT_PRINCIPLES = [
        "답을 직접 주지 말고, 방향만 제시하세요",
        "구체적인 계산 결과는 제공하지 마세요",
        "학생의 사고 과정을 자극하는 질문을 포함하세요",
        "단계별로 점진적인 힌트를 제공하세요"
    ]
    
    # 힌트 구조
    HINT_STRUCTURE = [
        "1. **접근 방향**: 어떤 방식으로 문제에 접근해야 하는지",
        "2. **핵심 개념**: Wikipedia에서 관련 개념을 검색하여 필요한 이론 설명",
        "3. **단계별 가이드**: 풀이의 대략적인 단계 (계산 결과 없이)",
        "4. **주의사항**: 자주 하는 실수나 주의할 점",
        "5. **자가 점검**: 학생이 자신의 풀이를 확인할 수 있는 방법",
        "6. **추가 학습**: 더 깊이 공부할 수 있는 관련 주제"
    ]

class PromptTemplates:
    """프롬프트 템플릿"""
    
    SOLUTION_PROMPT = """
당신은 세계적으로 유명한 수학 교수입니다. 학생들에게 수학 문제를 명확하고 체계적으로 설명하는 것이 전문입니다.

다음 수학 문제를 완벽하게 풀어주세요:

**문제:** {problem}
**주제:** {topics}
**난이도:** {difficulty}

다음 단계를 철저히 따라 풀이해주세요:

1. **문제 분석**: 문제에서 요구하는 것이 무엇인지 명확히 파악하고 설명
2. **개념 설명**: Wikipedia 도구를 사용하여 관련 수학적 개념들을 검색하고 설명
3. **풀이 전략**: 어떤 방법으로 문제를 해결할 것인지 단계별 계획 제시
4. **상세 계산**: llm-math 도구를 사용하여 모든 계산을 정확히 수행
5. **답안 검증**: 구한 답이 올바른지 다시 한번 확인
6. **결과 해석**: 답의 의미와 실제적 의미 설명

각 단계를 명확히 구분하고, 학생이 이해하기 쉽도록 설명해주세요.
모든 계산은 llm-math 도구를 사용하여 정확히 수행하세요.
관련 개념은 Wikipedia에서 검색하여 정확한 정보를 제공하세요.

**중요**: 모든 설명과 답변은 반드시 한글로 작성해주세요.
"""

    FEEDBACK_PROMPT = """
당신은 수학 교육 평가 전문가입니다. 학생의 답안을 공정하고 건설적으로 평가하는 것이 전문입니다.

**문제:** {problem}
**주제:** {topics}
**난이도:** {difficulty}

**학생의 답안:**
{user_answer}

다음 기준으로 상세히 평가해주세요:

**평가 기준 (총 100점):**
{evaluation_criteria}

**평가 과정:**
1. 먼저 llm-math 도구를 사용하여 정답을 직접 계산해보세요
2. Wikipedia에서 관련 개념을 검색하여 학생의 이해도를 평가하세요
3. 학생의 각 단계를 위 기준에 따라 평가하세요
4. 구체적인 개선 방향을 제시하세요
5. 추가 학습이 필요한 개념이 있다면 Wikipedia 링크와 함께 안내하세요

**출력 형식:**
반드시 마지막에 "총점: XX점" 형태로 점수를 명시해주세요.

{feedback_tone}

**중요**: 모든 평가와 피드백은 반드시 한글로 작성해주세요.
"""

    HINT_PROMPT = """
당신은 뛰어난 수학 튜터입니다. 학생들이 스스로 문제를 해결할 수 있도록 적절한 힌트를 제공하는 것이 전문입니다.

**문제:** {problem}
**주제:** {topics}
**기본 힌트:** {basic_hint}

학생이 스스로 답을 찾을 수 있도록 다음과 같은 힌트를 제공해주세요:

**힌트 제공 원칙:**
{hint_principles}

**힌트 구성:**
{hint_structure}

Wikipedia 도구를 활용하여 정확한 개념 설명을 제공하되, 학생의 학습 수준에 맞게 설명하세요.
학생이 "아하!" 하는 순간을 경험할 수 있도록 도와주세요.

**중요**: 모든 힌트와 설명은 반드시 한글로 작성해주세요.
"""

class EvaluationCriteria:
    """평가 기준"""
    
    DEFAULT_CRITERIA = """
1. **문제 이해도 (20점)**: 문제를 올바르게 이해했는가?
   - 주어진 조건을 정확히 파악했는가?
   - 구하고자 하는 것을 명확히 인식했는가?

2. **접근 방법 (25점)**: 적절한 수학적 방법이나 공식을 선택했는가?
   - 문제 유형에 맞는 해결 방법을 선택했는가?
   - 필요한 공식이나 정리를 올바르게 활용했는가?

3. **계산 정확성 (25점)**: 계산 과정이 정확한가?
   - 산술 계산이 정확한가?
   - 대수적 조작이 올바른가?

4. **논리적 흐름 (20점)**: 풀이 과정이 논리적으로 연결되는가?
   - 각 단계 간의 연결이 명확한가?
   - 추론 과정이 타당한가?

5. **최종 답안 (10점)**: 올바른 최종 답을 도출했는가?
   - 답의 형태가 적절한가?
   - 단위나 표기법이 올바른가?
"""

    SUBJECT_SPECIFIC_CRITERIA = {
        "미분": """
추가 평가 요소:
- 미분 공식의 올바른 적용
- 연쇄법칙 사용의 정확성
- 함수의 연속성 및 미분가능성 고려
""",
        "적분": """
추가 평가 요소:
- 적분 공식의 올바른 선택
- 적분 구간의 정확한 설정
- 적분상수 처리의 적절성
""",
        "확률": """
추가 평가 요소:
- 확률 공리의 올바른 적용
- 조건부 확률의 정확한 이해
- 확률 분포의 적절한 활용
""",
        "선형대수": """
추가 평가 요소:
- 행렬 연산의 정확성
- 벡터 공간 개념의 이해
- 선형변환의 기하학적 의미 파악
""",
        "급수": """
추가 평가 요소:
- 수렴성 판정법의 올바른 선택
- 수렴 조건의 정확한 확인
- 급수의 성질 이해도
"""
    }

class ResponseFormatting:
    """응답 포맷팅"""
    
    # 단계별 키워드 (굵게 표시용)
    STEP_KEYWORDS = [
        '단계', 'Step', '분석', '설명', '계산', '검증', '결과',
        '문제 분석', '개념 설명', '풀이 전략', '상세 계산', '답안 검증', '결과 해석'
    ]
    
    # 평가 항목 키워드
    EVALUATION_KEYWORDS = [
        '문제 이해도', '접근 방법', '계산 정확성', '논리적 흐름', '최종 답안', '총점',
        '평가 결과', '개선 방향', '추가 학습'
    ]
    
    # 힌트 구성 키워드
    HINT_KEYWORDS = [
        '접근 방향', '핵심 개념', '단계별', '주의사항', '자가 점검', '추가 학습',
        '힌트', 'Hint', '가이드', 'Guide'
    ]
    
    # 점수 추출 패턴
    SCORE_PATTERNS = [
        r'총점[:\s]*(\d+)점',
        r'점수[:\s]*(\d+)점',
        r'총점[:\s]*(\d+)',
        r'점수[:\s]*(\d+)',
        r'(\d+)점',
        r'score[:\s]*(\d+)',
        r'total[:\s]*(\d+)',
        r'final[:\s]*score[:\s]*(\d+)'
    ]
    
    # 마크다운 강조 패턴
    MARKDOWN_PATTERNS = {
        'bold': r'**{}**',
        'italic': r'*{}*',
        'code': r'`{}`',
        'header1': r'# {}',
        'header2': r'## {}',
        'header3': r'### {}'
    }
